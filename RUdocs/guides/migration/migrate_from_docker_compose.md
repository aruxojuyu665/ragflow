# Руководство по миграции данных

Распространённый сценарий — обработка больших наборов данных на мощном инстансе (например, с GPU), а затем перенос всего сервиса RAGFlow в другую производственную среду (например, сервер с CPU). В этом руководстве объясняется, как безопасно создать резервную копию и восстановить ваши данные с помощью предоставленного скрипта миграции.

## Определение ваших данных

По умолчанию RAGFlow использует Docker volumes (тома Docker) для хранения всех постоянных данных, включая вашу базу данных, загруженные файлы и поисковые индексы. Вы можете увидеть эти тома, выполнив:

```bash
docker volume ls
```

Вывод будет выглядеть примерно так:

```text
DRIVER    VOLUME NAME
local     docker_esdata01
local     docker_minio_data
local     docker_mysql_data
local     docker_redis_data
```

Эти тома содержат все данные, которые необходимо мигрировать.

## Шаг 1: Остановите сервисы RAGFlow

Перед началом миграции необходимо остановить все запущенные сервисы RAGFlow на **исходной машине**. Перейдите в корневую директорию проекта и выполните:

```bash
docker-compose -f docker/docker-compose.yml down
```

**Важно:** Не используйте флаг `-v` (например, `docker-compose down -v`), так как это удалит все ваши тома данных. Скрипт миграции включает проверку и не позволит запустить его, если сервисы активны.

## Шаг 2: Создайте резервную копию данных

Мы предоставляем удобный скрипт для упаковки всех ваших томов данных в одну папку резервной копии.

Для быстрого просмотра команд и опций скрипта выполните:
```bash
bash docker/migration.sh help
```

Чтобы создать резервную копию, выполните следующую команду из корневой директории проекта:

```bash
bash docker/migration.sh backup
```

Это создаст папку `backup/` в корне проекта, содержащую сжатые архивы ваших томов данных.

Вы также можете указать собственное имя для папки резервной копии:

```bash
bash docker/migration.sh backup my_ragflow_backup
```

В этом случае будет создана папка с именем `my_ragflow_backup/`.

## Шаг 3: Передайте папку резервной копии

Скопируйте всю папку резервной копии (например, `backup/` или `my_ragflow_backup/`) с вашей исходной машины в директорию проекта RAGFlow на **целевой машине**. Для передачи можно использовать инструменты `scp`, `rsync` или физический носитель.

## Шаг 4: Восстановите данные

На **целевой машине** убедитесь, что сервисы RAGFlow не запущены. Затем используйте скрипт миграции для восстановления данных из папки резервной копии.

Если ваша папка резервной копии называется `backup/`, выполните:

```bash
bash docker/migration.sh restore
```

Если вы использовали пользовательское имя, укажите его в команде:

```bash
bash docker/migration.sh restore my_ragflow_backup
```

Скрипт автоматически создаст необходимые Docker volumes и распакует данные.

**Примечание:** Если скрипт обнаружит, что Docker volumes с такими же именами уже существуют на целевой машине, он предупредит вас, что восстановление перезапишет существующие данные, и запросит подтверждение перед продолжением.

## Шаг 5: Запустите сервисы RAGFlow

После завершения процесса восстановления вы можете запустить сервисы RAGFlow на новой машине:

```bash
docker-compose -f docker/docker-compose.yml up -d
```

**Примечание:** Если вы уже собирали сервис с помощью docker-compose ранее, возможно, вам потребуется создать резервную копию данных для целевой машины, как описано в этом руководстве, и выполнить:

```bash
# Пожалуйста, сделайте резервную копию с помощью `sh docker/migration.sh backup backup_dir_name` перед выполнением следующей команды.
# !!! флаг -v в этой команде удалит исходный docker volume
docker-compose -f docker/docker-compose.yml down -v
docker-compose -f docker/docker-compose.yml up -d
```

Теперь ваш экземпляр RAGFlow работает со всеми данными с вашей исходной машины.