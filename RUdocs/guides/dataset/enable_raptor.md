---
sidebar_position: 7
slug: /enable_raptor
---

# Включение RAPTOR

Рекурсивный абстрактный метод, используемый для извлечения знаний и суммирования в длинных контекстах, обеспечивающий баланс между широким семантическим пониманием и детальной проработкой.

---

RAPTOR (Recursive Abstractive Processing for Tree Organized Retrieval) — усовершенствованная техника предобработки документов, представленная в [статье 2024 года](https://arxiv.org/html/2401.18059v1). Разработанная для решения задач с многошаговыми вопросами и ответами, RAPTOR выполняет рекурсивную кластеризацию и суммирование фрагментов документа для построения иерархической древовидной структуры. Это позволяет осуществлять более контекстно-осведомленный поиск по длинным документам. В RAGFlow версии 0.6.0 RAPTOR интегрирован для кластеризации документов как часть конвейера предобработки данных между извлечением данных и индексированием, как показано ниже.

![document_clustering](https://raw.githubusercontent.com/infiniflow/ragflow-docs/main/images/document_clustering_as_preprocessing.jpg)

Наши тесты с этим новым подходом демонстрируют передовые (SOTA) результаты в задачах вопрос-ответ, требующих сложного многошагового рассуждения. Комбинируя RAPTOR retrieval с нашими встроенными методами разбиения на фрагменты и/или другими подходами retrieval-augmented generation (RAG), вы можете дополнительно повысить точность ответов на вопросы.

:::danger WARNING
Включение RAPTOR требует значительных объёмов памяти, вычислительных ресурсов и токенов.
:::

## Основные принципы

После того как исходные документы разбиты на фрагменты, эти фрагменты группируются по семантическому сходству, а не по их исходному порядку в тексте. Кластеры затем суммируются в более крупные фрагменты с помощью стандартной модели чата вашей системы. Этот процесс применяется рекурсивно, формируя древовидную структуру с различными уровнями суммирования снизу вверх. Как показано на рисунке ниже, начальные фрагменты образуют листовые узлы (отмечены синим цветом) и рекурсивно суммируются в корневой узел (отмечен оранжевым).

![raptor](https://raw.githubusercontent.com/infiniflow/ragflow-docs/main/images/clustering_and_summarizing.jpg)

Рекурсивная кластеризация и суммирование обеспечивают широкое понимание (корневым узлом), а также детальную проработку (листовыми узлами), необходимые для многошагового вопрос-ответа.

## Сценарии

Для задач многошагового вопрос-ответа, включающих сложное многоступенчатое рассуждение, часто существует семантический разрыв между вопросом и ответом. В результате поиск по вопросу часто не позволяет найти релевантные фрагменты, которые способствуют правильному ответу. RAPTOR решает эту проблему, предоставляя модели чата более богатые, контекстно осведомлённые и релевантные фрагменты для суммирования, что обеспечивает целостное понимание без потери мелких деталей.

:::tip NOTE
Для задач многошагового вопрос-ответа также могут использоваться knowledge graphs (графы знаний). Подробнее см. [Построение графа знаний](./construct_knowledge_graph.md). Вы можете использовать любой из подходов или оба, но убедитесь, что понимаете связанные с этим затраты памяти, вычислительных ресурсов и токенов.
:::

## Требования

Для суммирования кластеризованного контента используется стандартная модель чата системы. Перед началом убедитесь, что у вас правильно настроена модель чата:

![Set default models](https://raw.githubusercontent.com/infiniflow/ragflow-docs/main/images/set_default_models.jpg)

## Настройки

Функция RAPTOR по умолчанию отключена. Чтобы включить её, вручную активируйте переключатель **Use RAPTOR to enhance retrieval** на странице **Configuration** вашего набора данных.

### Prompt

Следующий prompt будет применяться *рекурсивно* для суммирования кластеров, где `{cluster_content}` служит внутренним параметром. Рекомендуется пока оставить его без изменений. Дизайн будет обновлён в будущем.

```
Please summarize the following paragraphs... Paragraphs as following:
      {cluster_content}
The above is the content you need to summarize.
```

### Max token

Максимальное количество токенов на один сгенерированный суммарный фрагмент. По умолчанию 256, максимальное значение — 2048.

### Threshold

В RAPTOR фрагменты группируются по семантическому сходству. Параметр **Threshold** задаёт минимальный уровень сходства, необходимый для объединения фрагментов в кластер.

По умолчанию 0.1, максимальное значение — 1. Более высокий **Threshold** означает меньшее количество фрагментов в каждом кластере, а более низкий — большее.

### Max cluster

Максимальное количество создаваемых кластеров. По умолчанию 64, максимальное значение — 1024.

### Random seed

Случайное начальное значение. Нажмите **+** для изменения значения seed.

## Быстрый старт

1. Перейдите на страницу **Configuration** вашего набора данных и обновите:
   
   - Prompt: *необязательно* — рекомендуем оставить без изменений, пока не разберётесь в механизме.
   - Max token: *необязательно*
   - Threshold: *необязательно*
   - Max cluster: *необязательно*

2. Перейдите на страницу **Files** вашего набора данных, нажмите кнопку **Generate** в правом верхнем углу страницы, затем выберите **RAPTOR** из выпадающего списка для запуска процесса построения RAPTOR.

   *Вы можете нажать кнопку паузы в выпадающем списке, чтобы при необходимости остановить процесс построения.*

3. Вернитесь на страницу **Configuration**:  
   
   *Поле **RAPTOR** изменится с `Not generated` на `Generated at a specific timestamp` после генерации иерархической древовидной структуры RAPTOR. Вы можете удалить её, нажав кнопку корзины справа от поля.*

4. После генерации иерархической структуры RAPTOR ваш чат-ассистент и компонент **Retrieval** по умолчанию будут использовать её для поиска.