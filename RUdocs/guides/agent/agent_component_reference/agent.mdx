---
sidebar_position: 2
slug: /agent_component
---

# Компонент Agent (Агент)

Компонент, оснащённый возможностями рассуждения, использования инструментов и многокомпонентного взаимодействия.

---

Компонент **Agent** тонко настраивает LLM и задаёт его prompt (подсказку). Начиная с версии v0.20.5, компонент **Agent** способен работать автономно и обладает следующими возможностями:

- Автономное рассуждение с рефлексией и корректировкой на основе обратной связи из окружения.
- Использование инструментов или субагентов для выполнения задач.

## Сценарии

Компонент **Agent** необходим, когда требуется, чтобы LLM помогал с суммированием, переводом или контролем различных задач.

## Предварительные требования

1. Убедитесь, что у вас правильно настроена модель чата:

![Установите модели по умолчанию](https://raw.githubusercontent.com/infiniflow/ragflow-docs/main/images/set_default_models.jpg)

2. Если ваш Agent включает извлечение из датасета, убедитесь, что вы [правильно настроили целевой(е) датасет(ы)](../../dataset/configure_knowledge_base.md).

## Быстрый старт

### 1. Кликните на компонент **Agent**, чтобы открыть панель конфигурации  

Соответствующая панель конфигурации появится справа от холста. Используйте эту панель для определения и тонкой настройки поведения компонента **Agent**.

### 2. Выберите модель

Нажмите **Model** и выберите модель чата из выпадающего меню.

:::tip ЗАМЕТКА
Если модель не отображается, проверьте, добавили ли вы модель чата на странице **Model providers**.
:::

### 3. Обновите системный prompt (необязательно)

Системный prompt обычно определяет роль вашей модели. Вы можете оставить системный prompt без изменений или настроить его для переопределения значения по умолчанию.

### 4. Обновите пользовательский prompt

Пользовательский prompt обычно определяет задачу модели. Переменная `sys.query` заполняется автоматически. Введите `/` или нажмите **(x)**, чтобы просмотреть или добавить переменные.

В этом быстром старте предполагается, что ваш компонент **Agent** используется автономно (без инструментов или субагентов), тогда вам также может понадобиться указать извлечённые фрагменты с помощью переменной `formalized_content`:

![](https://raw.githubusercontent.com/infiniflow/ragflow-docs/main/images/standalone_user_prompt_variable.jpg)

### 5. Пропустите разделы Tools и Agent

Разделы **+ Add tools** и **+ Add agent** используются *только*, если вам нужно настроить компонент **Agent** как планировщик (с инструментами или субагентами под ним). В этом быстром старте предполагается, что ваш компонент **Agent** используется автономно (без инструментов или субагентов).

### 6. Выберите следующий компонент

При необходимости нажмите кнопку **+** на компоненте **Agent**, чтобы выбрать следующий компонент в рабочем процессе из выпадающего списка.

## Подключение к серверу MCP в качестве клиента

:::danger ВАЖНО
В этом разделе предполагается, что ваш **Agent** будет настроен как планировщик с инструментом Tavily под ним.
:::

### 1. Перейдите на страницу конфигурации MCP

![](https://raw.githubusercontent.com/infiniflow/ragflow-docs/main/images/mcp_page.jpg)

### 2. Настройте ваш сервер Tavily MCP

Обновите имя вашего MCP сервера, URL (включая API ключ), тип сервера и другие необходимые настройки. При правильной настройке будут отображены доступные инструменты.

![](https://raw.githubusercontent.com/infiniflow/ragflow-docs/main/images/edit_mcp_server.jpg)

### 3. Перейдите на страницу редактирования вашего Agent

### 4. Подключитесь к вашему MCP серверу

1. Нажмите **+ Add tools**:

![](https://raw.githubusercontent.com/infiniflow/ragflow-docs/main/images/add_tools.jpg)

2. Нажмите **MCP**, чтобы показать доступные MCP серверы.

3. Выберите ваш MCP сервер:

   *Целевой MCP сервер появится под вашим компонентом Agent, и ваш Agent будет самостоятельно решать, когда вызывать доступные инструменты, которые он предлагает.*

![](https://raw.githubusercontent.com/infiniflow/ragflow-docs/main/images/choose_tavily_mcp_server.jpg)

### 5. Обновите системный prompt для указания условий срабатывания (необязательно)

Для обеспечения надёжного вызова инструментов вы можете указать в системном prompt, какие задачи должны запускать вызов каждого инструмента.

### 6. Просмотрите доступные инструменты вашего MCP сервера

На холсте кликните по вновь добавленному серверу Tavily, чтобы просмотреть и выбрать доступные инструменты:

![](https://raw.githubusercontent.com/infiniflow/ragflow-docs/main/images/tavily_mcp_server.jpg)

## Конфигурации

### Модель

Нажмите на выпадающее меню **Model**, чтобы открыть окно настройки модели.

- **Model**: Модель чата для использования.  
  - Убедитесь, что вы правильно настроили модель чата на странице **Model providers**.
  - Вы можете использовать разные модели для разных компонентов для повышения гибкости или улучшения общей производительности.
- **Creavity**: Быстрый доступ к настройкам **Temperature**, **Top P**, **Presence penalty** и **Frequency penalty**, определяющим уровень свободы модели. От **Improvise** (Импровизация), **Precise** (Точность) до **Balance** (Баланс), каждая предустановка соответствует уникальной комбинации этих параметров.  
  Параметр имеет три варианта:
  - **Improvise**: Генерирует более креативные ответы.
  - **Precise**: (По умолчанию) Генерирует более консервативные ответы.
  - **Balance**: Средний вариант между **Improvise** и **Precise**.
- **Temperature**: Уровень случайности вывода модели.  
  По умолчанию 0.1.
  - Меньшие значения приводят к более детерминированным и предсказуемым ответам.
  - Большие значения — к более креативным и разнообразным ответам.
  - Значение 0 приводит к одинаковому выводу для одного и того же prompt.
- **Top P**: Nucleus sampling (ядровая выборка).  
  - Снижает вероятность генерации повторяющегося или неестественного текста, устанавливая порог *P* и ограничивая выбор токенов кумулятивной вероятностью выше *P*.
  - По умолчанию 0.3.
- **Presence penalty**: Поощряет модель включать более разнообразные токены в ответ.  
  - Более высокое значение заставляет модель чаще генерировать токены, ещё не встречавшиеся в тексте.
  - По умолчанию 0.4.
- **Frequency penalty**: Снижает склонность модели повторять одни и те же слова или фразы слишком часто.  
  - Более высокое значение делает модель более консервативной в использовании повторяющихся токенов.
  - По умолчанию 0.7.
- **Max tokens**:  
  Максимальная длина вывода модели в количестве токенов (слов или частей слов). По умолчанию отключено, позволяя модели самостоятельно определять длину ответа.

:::tip ЗАМЕТКА
- Нет необходимости использовать одну и ту же модель для всех компонентов. Если конкретная модель плохо справляется с задачей, рассмотрите возможность использования другой.
- Если вы не уверены в механизме работы **Temperature**, **Top P**, **Presence penalty** и **Frequency penalty**, просто выберите один из трёх вариантов **Creavity**.
:::

### Системный prompt

Обычно системный prompt используется для описания задачи для LLM, указания способа ответа и других дополнительных требований. Мы не планируем подробно рассматривать эту тему, так как она может быть столь же обширной, как prompt engineering (инженерия подсказок). Однако обратите внимание, что системный prompt часто используется вместе с ключами (переменными), которые служат различными входными данными для LLM.

Компонент **Agent** опирается на ключи (переменные) для указания своих входных данных. Его непосредственный вышестоящий компонент *не обязательно* является источником данных, а стрелки в рабочем процессе указывают *только* последовательность обработки. Ключи в компоненте **Agent** используются вместе с системным prompt для задания входных данных LLM. Используйте косую черту `/` или кнопку **(x)** для отображения доступных ключей.

#### Расширенное использование

Начиная с версии v0.20.5, в поле **System prompt** доступны четыре блоки prompt на уровне фреймворка, позволяющие настраивать и *переопределять* подсказки на уровне фреймворка. Введите `/` или нажмите **(x)**, чтобы просмотреть их; они отображаются под пунктом **Framework** в выпадающем меню.

- Блок prompt `task_analysis`
  - Отвечает за анализ задач — либо пользовательской, либо назначенной ведущим Агентом, когда компонент **Agent** действует как субагент.
  - Референс-дизайн: [analyze_task_system.md](https://github.com/infiniflow/ragflow/blob/main/rag/prompts/analyze_task_system.md) и [analyze_task_user.md](https://github.com/infiniflow/ragflow/blob/main/rag/prompts/analyze_task_user.md)
  - Доступен *только*, когда компонент **Agent** действует как планировщик с инструментами или субагентами под ним.
  - Входные переменные:
    - `agent_prompt`: Системный prompt.
    - `task`: Пользовательский prompt для ведущего агента или субагента. Пользовательский prompt ведущего агента задаётся пользователем, а субагента — ведущим агентом при делегировании задач.
    - `tool_desc`: Описание инструментов и субагентов, которые могут быть вызваны.
    - `context`: Операционный контекст, хранящий взаимодействия между агентом, инструментами и субагентами; изначально пуст.
- Блок prompt `plan_generation`
  - Создаёт план для дальнейшего выполнения компонентом **Agent** на основе результатов анализа задачи.
  - Референс-дизайн: [next_step.md](https://github.com/infiniflow/ragflow/blob/main/rag/prompts/next_step.md)
  - Доступен *только*, когда компонент **Agent** действует как планировщик с инструментами или субагентами под ним.
  - Входные переменные:
    - `task_analysis`: Результат анализа текущей задачи.
    - `desc`: Описание вызываемых в данный момент инструментов или субагентов.
    - `today`: Текущая дата.
- Блок prompt `reflection`
  - Позволяет компоненту **Agent** рефлексировать, улучшая точность и эффективность выполнения задачи.
  - Референс-дизайн: [reflect.md](https://github.com/infiniflow/ragflow/blob/main/rag/prompts/reflect.md)
  - Доступен *только*, когда компонент **Agent** действует как планировщик с инструментами или субагентами под ним.
  - Входные переменные:
    - `goal`: Цель текущей задачи. Это пользовательский prompt для ведущего агента или субагента. Пользовательский prompt ведущего агента задаётся пользователем, а субагента — ведущим агентом.
    - `tool_calls`: История вызовов инструментов.
    - `call.name`: Имя вызванного инструмента.
    - `call.result`: Результат вызова инструмента.
- Блок prompt `citation_guidelines`
  - Референс-дизайн: [citation_prompt.md](https://github.com/infiniflow/ragflow/blob/main/rag/prompts/citation_prompt.md)

*На скриншотах ниже показаны блоки prompt фреймворка, доступные компоненту **Agent** как автономному, так и в роли планировщика (с инструментом Tavily под ним):*

![автономный](https://raw.githubusercontent.com/infiniflow/ragflow-docs/main/images/standalone_agent_framework_block.jpg)

![планировщик](https://raw.githubusercontent.com/infiniflow/ragflow-docs/main/images/planner_agent_framework_blocks.jpg)

### Пользовательский prompt

Пользовательский prompt, определённый пользователем. По умолчанию — `sys.query`, пользовательский запрос. Как правило, при использовании компонента **Agent** как автономного модуля (не как планировщика) обычно необходимо указать здесь выходную переменную соответствующего компонента **Retrieval** (`formalized_content`) в качестве части входных данных для LLM.

### Инструменты

Вы можете использовать компонент **Agent** как участника, который рассуждает и рефлексирует с помощью других инструментов; например, **Retrieval** может служить таким инструментом для **Agent**.

### Агент

Вы используете компонент **Agent** как участника, который рассуждает и рефлексирует с помощью субагентов или других инструментов, формируя систему с несколькими агентами.

### Размер окна сообщений

Целое число, указывающее количество предыдущих раундов диалога, которые будут переданы в LLM. Например, если установлено значение 12, токены из последних 12 раундов диалога будут поданы на вход LLM. Эта функция потребляет дополнительные токены.

:::tip ВАЖНО
Эта функция используется *только* для многоходового диалога.
:::

### Максимальное количество повторных попыток

Определяет максимальное число попыток, которые агент предпримет для повторного выполнения неудачной задачи или операции, прежде чем остановиться или сообщить о сбое.

### Задержка после ошибки

Время ожидания в секундах, которое агент соблюдает перед повторной попыткой неудачной задачи, что помогает избежать немедленных повторных попыток и даёт системе время для улучшения условий. По умолчанию 1 секунда.

### Максимальное количество раундов рефлексии

Определяет максимальное количество раундов рефлексии выбранной модели чата. По умолчанию 1 раунд.

:::tip ЗАМЕТКА
Увеличение этого значения значительно увеличит время ответа вашего агента.
:::

### Вывод

Глобальное имя переменной для вывода компонента **Agent**, к которому могут обращаться другие компоненты в рабочем процессе.

## Часто задаваемые вопросы

### Почему мой Agent отвечает так долго?

Подробнее смотрите [здесь](../best_practices/accelerate_agent_question_answering.md).